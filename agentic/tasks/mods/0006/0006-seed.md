# Mod 0006 - SQL Editor and Requery Functionality

## Initial Concept

Add the ability for users to view, edit, copy, and re-execute SQL queries from AI responses, enabling power users to iterate quickly and refine queries without going back through AI.

## Problem Statement

When AI generates SQL, users can view it but cannot:
- Copy it to their clipboard for external use
- Modify it to fix small issues or add refinements
- Re-run the modified query to see updated results
- Save improved queries back to the system

This requires users to ask AI repeatedly for minor SQL tweaks, wasting time and API calls.

## Desired Outcome

When viewing SQL in the modal:
1. **Copy SQL Button** - One-click copy to clipboard
2. **Editable SQL Field** - Textarea or code editor to modify the query
3. **Requery Button** - Execute the edited SQL and display new results
4. **Security Validation** - Prevent destructive operations (UPDATE, DELETE, DROP, etc.)
5. **Error Handling** - Clear feedback if SQL is invalid
6. **Save Option** - "Save as Example Question" for useful queries

## Technical Requirements

### Frontend
- Replace read-only SQL display with editable textarea or Monaco Editor
- Add "Copy SQL" button using `navigator.clipboard.writeText()`
- Add "Requery" button that posts to new backend endpoint
- Show "Modified" badge if SQL differs from original
- Display SQL errors clearly if requery fails
- Optional: Syntax highlighting for better readability

### Backend
- New endpoint: `POST /api/ask/requery` accepting `{ sql: string, original_question?: string }`
- Reuse existing `validate_sql()` function for security
- Same read-only enforcement and statement timeout as AI queries
- Return same response format as `/api/ask` for consistency
- Log all manual SQL executions for audit trail

### Security
- Validate SQL contains only SELECT statements
- Block keywords: UPDATE, DELETE, DROP, ALTER, CREATE, INSERT, TRUNCATE
- Enforce 10-second statement timeout
- No dynamic table/schema manipulation
- Log user-edited queries separately from AI-generated

## UX Flow

1. User asks question via AI
2. AI generates SQL and results
3. User clicks "Show SQL" â†’ modal opens
4. User sees SQL with Copy and Requery buttons
5. User edits SQL in modal
6. User clicks "Requery"
7. Backend validates and executes
8. Results replace previous response (or show in split view?)
9. Optional: "Save this query" button to add to examples

## Future Enhancements (v2)

- Side-by-side diff: original SQL vs edited SQL
- Query history: See previous edits
- Export results as CSV from requery
- Share edited query with team
- SQL formatting/beautification

## Implementation Notes

- This builds on mod 0001 (AI questions system)
- Works alongside mod 0005 (saved SQL system)
- Could inspire mod 0003 admin UI design (SQL editor component reuse)
