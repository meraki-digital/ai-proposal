# Mod 0005 - Hybrid AI Query System with Saved SQL

## Initial Concept

Enhance the AI question system to support pre-written SQL for verified questions, providing predictability and reliability while maintaining AI flexibility for custom queries.

## Problem Statement

Currently, all queries go through AI SQL generation, which can produce inconsistent results for common questions. Users want reliable, repeatable answers for frequently-asked questions while keeping the flexibility to ask anything.

## Desired Outcome

A hybrid system where:
- **Verified questions** have pre-written SQL stored in the database
- **Custom questions** still use AI to generate SQL
- Both types get AI-generated narrative summaries
- Admin can write, test, and save SQL for any question
- A "Favorites" category at the top showcases best questions

## Key Features

1. **Add `saved_sql` field** to `core.ai_example_questions` table (TEXT, nullable)
2. **Hybrid execution logic** in backend:
   - If `saved_sql` exists: Execute it directly, pass results to AI for summary only
   - If `saved_sql` is null: Full AI workflow (generate SQL + summary)
3. **Add "Favorites" category** with `sort_order = 0` to display first
4. **Date parameter substitution** in saved SQL (replace `{start_date}` and `{end_date}` placeholders)
5. **Admin UI enhancements** (extends mod 0003):
   - SQL editor with syntax highlighting
   - Test query button (run against database)
   - Move questions to Favorites category
   - Toggle between AI-generated and saved SQL modes

## Backend Changes

- Add migration to add `saved_sql` column
- Update `/api/ask` endpoint to check for saved SQL first
- Create prompt template for "summary only" mode
- Add parameter substitution for date ranges
- Add "Favorites" category to seed data

## Frontend Changes (mod 0003)

- Admin UI should show SQL editor when editing questions
- Visual indicator (badge) for questions with saved SQL
- Test SQL button that runs query and shows results preview
- Category selector includes Favorites option

## Success Metrics

- Example questions with saved SQL execute in <500ms (vs 2-5s for AI)
- 100% consistent results for verified questions
- Users can still ask any custom question with AI
