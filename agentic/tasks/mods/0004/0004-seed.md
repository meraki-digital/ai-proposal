# Module 0004 Seed: AI Context Management System

## Initial Concept

Create an admin UI that allows sophisticated users to view and edit the AI coaching context (currently hardcoded in `schema_context` variable) that guides SQL generation, with proper guardrails to prevent breaking the AI's accuracy.

---

## Problem Statement

### Current State Challenges
- AI context is hardcoded in `poc/backend/api_routes/ask.py` as a large string variable
- Only developers can modify the context through code changes
- Changes require code deployment and restart
- No version history or ability to rollback bad changes
- No way to test context changes before applying to production
- Sophisticated users who understand their data can't contribute improvements

### User Pain Points
- Financial team discovers new calculation patterns but must ask developers to update context
- Domain experts can't refine business terminology or add examples
- No visibility into what the AI "knows" about the database
- Trial-and-error improvements require full development cycle

---

## Solution Vision

### What We're Building
An "AI Knowledge Base" admin interface where authorized users can:
- **View** the complete AI context in a structured, readable format
- **Edit** user-defined sections (business rules, examples, calculations)
- **Test** changes against sample questions before applying
- **Version** all changes with rollback capability
- **Audit** who changed what and when

### How It Works (High-Level)
1. User navigates to Admin → AI Knowledge Base
2. Sees context organized into sections (tables, relationships, rules, examples)
3. System-defined sections are locked (table schemas)
4. User-editable sections have an "Edit" button
5. User makes changes in markdown editor
6. Clicks "Test Context" to try it with sample questions
7. If satisfied, saves (creates new version)
8. If AI behavior degrades, can rollback to previous version

---

## Known Requirements

### Core Functionality (Must-Have)

1. **View Current Context**
   - Display all context sections in organized, readable format
   - Clearly distinguish system-locked vs user-editable sections
   - Show current version number and last modified info

2. **Edit User Sections**
   - Inline markdown editor for editable sections
   - Section types: Business Glossary, Calculation Examples, Query Patterns, Business Rules
   - Real-time character count and validation
   - Preview rendered markdown

3. **Test Changes**
   - "Test Mode" that uses new context without saving
   - Submit 3-5 test questions
   - Compare AI responses before/after changes
   - Show generated SQL for validation

4. **Version Control**
   - Save creates new version (doesn't overwrite)
   - Version history table showing: version #, timestamp, user, change summary
   - Rollback to any previous version
   - Diff view between versions

5. **Guardrails**
   - Syntax validation (prevent SQL injection patterns)
   - Max length limits per section (prevent bloat)
   - Required field validation
   - "Dangerous patterns" detection (DROP, DELETE, TRUNCATE in examples)

### Users
- **Primary:** Admin users (technical finance analysts)
- **Secondary:** Developers (can edit system sections if needed)

### Out of Scope (v1)
- Multi-user concurrent editing (lock-based later)
- AI-suggested context improvements (future enhancement)
- Automatic schema change detection
- Natural language context editing ("just tell me what to add")

---

## Technical Context

### Existing Infrastructure
- Module 0010 core: FastAPI backend, React frontend, PostgreSQL
- Module 0001: Admin panel structure, question library
- Current `schema_context` in `poc/backend/api_routes/ask.py`

### Tech Stack (Inherited from Module 0010)
- Backend: FastAPI (Python)
- Frontend: React 18+, TypeScript
- Database: PostgreSQL
- State: React hooks (no Redux needed for admin UI)

### Integration Points
- Reads context from new database tables instead of hardcoded string
- Modifies `/api/ask` endpoint to load context dynamically
- Adds admin routes: `/admin/ai-context/*`
- Integrates into existing admin navigation from Module 0001

---

## Data Structure (Initial Idea)

### Proposed Tables

**ai_context_sections** - Defines available sections
- section_id SERIAL PRIMARY KEY
- section_code VARCHAR(50) UNIQUE - e.g., 'table_schemas', 'calc_examples'
- section_name VARCHAR(100) - "Table Definitions"
- section_type VARCHAR(20) - 'system' or 'user'
- is_editable BOOLEAN
- sort_order INT
- description TEXT

**ai_context_content** - Actual content with versioning
- content_id SERIAL PRIMARY KEY
- section_id INT → ai_context_sections
- version_number INT
- content TEXT - The actual markdown/text content
- is_active BOOLEAN - Only one active version per section
- created_at TIMESTAMP
- created_by VARCHAR(100)
- change_summary VARCHAR(500)

**ai_context_audit** - Change history
- audit_id SERIAL PRIMARY KEY
- section_id INT
- old_version INT
- new_version INT
- changed_by VARCHAR(100)
- changed_at TIMESTAMP
- change_type VARCHAR(20) - 'create', 'update', 'rollback'
- notes TEXT

---

## Key Features Detail

### 1. Hybrid Context Model
**System Sections (Locked):**
- Table Schemas (auto-sync with actual DB if possible)
- Data Types
- Table Relationships
- Core SQL Patterns

**User Sections (Editable):**
- Business Glossary/Terminology
- Calculation Examples (Gross Margin, etc.)
- Common Query Patterns
- Business Rules & Constraints
- Domain-Specific Notes

### 2. Testing Workflow
- User edits "Calculation Examples" section
- Clicks "Test Context"
- Enters test questions: "What is gross margin for 2024?"
- System generates SQL using NEW context (in memory, not saved)
- Shows side-by-side: Current AI response vs New AI response
- User compares, then decides to Save or Discard

### 3. Safety Features
**Input Validation:**
- Max 10,000 chars per section
- No SQL injection patterns ('; DROP TABLE, etc.)
- Must contain certain keywords for critical sections (e.g., "transactions" must mention amount column)

**Change Approval (Optional Future):**
- Require second admin to approve context changes
- Preview changes in staging mode before production

---

## Success Metrics

1. **Usability:** Finance team can add new calculation example without developer help
2. **Safety:** No accidental AI breakage from bad context (rollback works)
3. **Adoption:** 3+ context improvements made by users in first month
4. **Quality:** AI accuracy improves or stays same (track query success rate)

---

## Open Questions for Discovery

1. Should system sections be truly locked, or editable by Developers only?
2. Do we need approval workflow, or trust admin users?
3. Should testing be required before saving, or optional?
4. How many test questions should be mandatory?
5. Should we track AI query success rate to detect context degradation?

---

## Example Use Case

**Scenario:** Finance team realizes AI doesn't understand "net operating income"

**Current State:**
1. Email developer: "AI doesn't understand NOI"
2. Developer updates schema_context
3. Deploy code
4. Test manually

**With Module 0004:**
1. Admin opens AI Knowledge Base
2. Edits "Business Glossary" section
3. Adds: "Net Operating Income (NOI) = Revenue - COGS - Other Operating Expense"
4. Clicks "Test Context"
5. Asks: "What is our NOI for Q1 2024?"
6. Sees AI generates correct SQL
7. Saves (new version created)
8. Immediately available to all users
9. If wrong, rollback in 30 seconds

---

## Phase 1 MVP Scope

**Must Have:**
- View all context sections
- Edit user sections with markdown editor
- Save with version number
- View version history
- Manual rollback

**Nice to Have (v2):**
- Test mode with sample questions
- Diff view between versions
- Auto-rollback if query failure rate spikes
- Syntax highlighting in editor
- Search within context

---

## Related Files

- Current context: `poc/backend/api_routes/ask.py` (schema_context variable)
- Will need to migrate existing content to database on first deployment

---

**Next Step:** Run "Do Step 1 for module 0004" using this seed as the starting point.
